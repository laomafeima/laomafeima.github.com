<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="markdown-hash" content="">

    <title>新安装的服务器 VPS 需要做的事情</title>

    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<header>
    <div id="go-back" onclick="javascript:history.back(-1);">↼</div>
</header>
<div class="markdown-body">
    <h1>新安装的服务器 VPS 需要做的事情</h1>
<p>当新购买或者安装 VPS 后，出去安全等目的，需要进行一些设置等，这里纪录一些必要的步骤。<br />
以下步骤以 Ubuntu 为例。</p>
<h2>添加新用户</h2>
<p>很多时候创建的 VPS 是 root 用户为了安全，建议去创建一个新的用户。</p>
<pre><code>sudo adduser username
</code></pre>
<p>按照提示输入信息即可</p>
<p>然后在修改配置文件添加 sudo 权限</p>
<pre><code>sudo vim /etc/sudoers
</code></pre>
<p>在文件里面最后添加</p>
<pre><code>username ALL=(ALL:ALL) NOPASSWD:ALL
</code></pre>
<h2>更新系统</h2>
<p>首先更新系统能及时获取已经修复的漏洞  </p>
<pre><code>sudo apt-get update  // 更新源
sudo apt-get upgrade // 更新已经安装的包
</code></pre>
<p>执行以上两个命令更新源和已经安装的包  </p>
<h2>配置 SSH</h2>
<p>启用密钥登录，禁止密码登录等能减少被暴力破解的风险。  </p>
<h4>密钥登录</h4>
<pre><code>ssh-keygen -t rsa -P '' -f ~/.ssh/id_rsa
</code></pre>
<p>生成密钥，按照提示输入即可生成。</p>
<pre><code>cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys
</code></pre>
<p>执行以上命令添加公钥，如果使用自己已经有的密钥，直接添加进 authorized_keys 即可。如果文件或者目录不存在创建即可。</p>
<pre><code>ssh localhost
</code></pre>
<p>如果能登录即配置成功<br />
如果还是无法登录，注意修改文件目录和文件权限。</p>
<h4>SSH 配置</h4>
<p>SSH 配置在 /etc/ssh/sshd_config  </p>
<pre><code>sudo vim /etc/ssh/sshd_config
</code></pre>
<p>进入配置文件，开始修改  </p>
<p>修改 SSH 登录端口</p>
<pre><code>#端口，修改成另外的端口。
Port 22
#关闭密码登录，如果没有，就添加配置
PasswordAuthentication no  
#禁止 root 用户登录
PermitRootLogin no
</code></pre>
<h2>配置 fail2ban</h2>
<p>fail2ban 可以限制登录次数，保证不被穷举破解。<br />
安装 fail2ban 执行命令</p>
<pre><code>sudo apt-get install fail2ban
</code></pre>
<p>配置 fail2ban 复制 jail.conf 到 jail.local 修改都在 jail.local 文件里</p>
<pre><code>cd /etc/fail2ban
sudo cp jail.conf jail.local
</code></pre>
<p>编辑配置文件</p>
<pre><code>sudo vim jail.local
</code></pre>
<p>修改配置文件，配置忽略 IP ，屏蔽时间，最大尝试次数。如下：</p>
<pre><code>[DEFAULT]
# "ignoreip" can be an IP address, a CIDR mask or a DNS host
ignoreip = 127.0.0.1
bantime  = 3600
maxretry = 3
</code></pre>
<p>可以根据自己的需要修改参数  </p>
<p>设置邮件提醒，配置文件修改成自己的邮件地址  </p>
<pre><code>destemail = your_email@domain.com
</code></pre>
<p>找到并修改：</p>
<pre><code>action = %(action_)s   # 找到这行
action = %(action_mw)s # 修改成这样
</code></pre>
<p>日志</p>
<pre><code>[ssh]
enabled = true
port    = ssh
filter  = sshd
logpath  = /var/log/auth.log
maxretry = 3
</code></pre>
<p>配置完成后，退出 vim 并且重启 fail2ban</p>
<pre><code>sudo /etc/init.d/fail2ban restart
</code></pre>
<h2>修改时区</h2>
<p>因为服务器或 VPS 机房可能在国外。不在同一个时区可能会有时差问题，修改服务器时间修改成本地时间，避免操作服务器的时候出现穿越的错觉。  </p>
<pre><code>sudo tzconfig  //如果命令不存在请使用
dpkg-reconfigure tzdata
</code></pre>
<p>选择 Shanghai（上海）<br />
然后复制配置，防止系统重启后时区改变  </p>
<pre><code>sudo cp /usr/share/zoneinfo/Asia/ShangHai /etc/localtime
</code></pre>
<p>设置网络时间同步</p>
<pre><code>ntpdate cn.pool.ntp.org
</code></pre>
<p>查看下当前时间是不是和本时区一致  </p>
<pre><code>date
</code></pre>
<h2>支持中文</h2>
<p>如果系统不支持中文，那么需要去配置中文环境  </p>
<pre><code>sudo apt-get install language-pack-zh-hant language-pack-zh-hans
</code></pre>
<p>编辑<code>/etc/default/locale</code> 文件，如果不存在就创建。</p>
<pre><code>sudo vim /etc/default/locale
</code></pre>
<p>添加内容</p>
<pre><code>LANG="en_US.UTF-8"
LANGUAGE="en_US:"
</code></pre>
<p>保存后输入<code>locale</code>查看当前配置，如果提示</p>
<pre><code>locale: Cannot set LC_CTYPE to default locale: No such file or directory
locale: Cannot set LC_MESSAGES to default locale: No such file or directory
locale: Cannot set LC_ALL to default locale: No such file or directory
LANG=en_US.UTF-8
LANGUAGE=en_US:en
LC_CTYPE="en_US.UTF-8"
LC_NUMERIC="en_US.UTF-8"
LC_TIME="en_US.UTF-8"
LC_COLLATE="en_US.UTF-8"
LC_MONETARY="en_US.UTF-8"
LC_MESSAGES="en_US.UTF-8"
LC_PAPER="en_US.UTF-8"
LC_NAME="en_US.UTF-8"
LC_ADDRESS="en_US.UTF-8"
LC_TELEPHONE="en_US.UTF-8"
LC_MEASUREMENT="en_US.UTF-8"
LC_IDENTIFICATION="en_US.UTF-8"
LC_ALL=
</code></pre>
<p>是缺少<code>en_US.UTF-8</code>造成的 </p>
<pre><code>sudo locale-gen en_US.UTF-8
</code></pre>
<p>安装 <code>en_US.UTF-8</code> 后查看当前配置 <code>locale</code> 就正常了。</p>
<h2>启用 BBR</h2>
<p>不支持 OpenVZ 虚拟化 VPS，需要内核版本4.9以及以上。<br />
下载最新版内核</p>
<pre><code>http://kernel.ubuntu.com/~kernel-ppa/mainline/
</code></pre>
<p>选择最新版本</p>
<pre><code>wget http://kernel.ubuntu.com/~kernel-ppa/mainline/v4.10.1/linux-headers-4.10.1-041001_4.10.1-041001.201702260735_all.deb
wget http://kernel.ubuntu.com/~kernel-ppa/mainline/v4.10.1/linux-headers-4.10.1-041001-generic_4.10.1-041001.201702260735_amd64.deb
wget http://kernel.ubuntu.com/~kernel-ppa/mainline/v4.10.1/linux-image-4.10.1-041001-generic_4.10.1-041001.201702260735_amd64.deb
</code></pre>
<p>下载后开始安装</p>
<pre><code>sudo dpkg -i linux-*.deb
</code></pre>
<p>更新 grub</p>
<pre><code>sudo update-grub
</code></pre>
<p>重启 VPS</p>
<pre><code>sudo reboot
</code></pre>
<p>查看当前内核</p>
<pre><code>uname -r
</code></pre>
<p>修改配置</p>
<pre><code>sudo bash -c 'echo "net.core.default_qdisc=fq" &gt;&gt; /etc/sysctl.conf'
sudo bash -c 'echo "net.ipv4.tcp_congestion_control=bbr" &gt;&gt; /etc/sysctl.conf'
</code></pre>
<p>需要关闭 BBR 的时候，从配置文件里面移除这两行配置。</p>
<p>使配置生效</p>
<pre><code>sysctl -p
</code></pre>
<p>查看配置</p>
<pre><code># sysctl net.ipv4.tcp_available_congestion_control
net.ipv4.tcp_available_congestion_control = bbr cubic reno
</code></pre>
<p>查看是否启用成功</p>
<pre><code># lsmod | grep bbr
tcp_bbr                20480  4
</code></pre>
<p>如果没有启动成功。再在重启一次服务器。</p>
</div>
<div class="bottom">
    
    <a href="/tag/服务器.html" class="tag" ># 服务器</a>
    
    <time datetime="2018-09-21">2018-09-21</time>
</div>
<footer>
    <a href="/notes.html" target="_blank" class="muted"><i>笔记</i></a>
    <i>/</i>
    <a href="/tags.html" target="_blank" class="muted"><i>标签</i></a>
    <i>/</i>
    <a href="/about.html" target="_blank" class="muted"><i>关于</i></a>
</footer>
<script src="/static/min.js"></script>
</body>
</html>