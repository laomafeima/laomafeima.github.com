<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>新服务器 VPS 需要做的事情</title>

    <meta name="description" content="新服务器 VPS 需要做的事情">
    <meta name="keywords" content="新,服务器,VPS,配置"/>
    <meta name="author" content="老馬"/>
    <link rel="icon" type="image/png" href="/status/favicon.png">
    <link rel="stylesheet" href="/status/main.css">
    <link rel="stylesheet" href="/status/markdown.css">
</head>
<body>
<header>
</header>
<div class="content markdown-body">

    <h1 id="-vps-">新安装的服务器 VPS 需要做的事情</h1>
    <p>当新购买或者安装 VPS 后，出去安全等目的，需要进行一些设置等，这里纪录一些必要的步骤。
    以下步骤以 Ubuntu 为例。</p>
    <h2 id="-">更新系统</h2>
    <p>首先更新系统能及时获取已经修复的漏洞  </p>
    <pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>sudo&nbsp;apt-get&nbsp;update&nbsp;&nbsp;//&nbsp;更新源</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>sudo&nbsp;apt-get&nbsp;upgrade&nbsp;//&nbsp;更新已经安装的包</span></span></span></div></pre><p>执行以上两个命令更新源和已经安装的包  </p>
    <h2 id="-ssh">配置 SSH</h2>
    <p>启用密钥登录，禁止密码登录等能减少被暴力破解的风险。  </p>
    <h4 id="-">密钥登录</h4>
    <pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>ssh-keygen&nbsp;-t&nbsp;dsa&nbsp;-P&nbsp;&#39;&#39;&nbsp;-f&nbsp;~/.ssh/id_dsa</span></span></span></div></pre><p>生成密钥，按照提示输入即可生成。</p>
    <pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>cat&nbsp;~/.ssh/id_dsa.pub&nbsp;&gt;&gt;&nbsp;~/.ssh/authorized_keys</span></span></span></div></pre><p>执行以上命令添加公钥，如果使用自己已经有的密钥，直接添加进 authorized_keys 即可。如果文件或者目录不存在创建即可。</p>
    <pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>ssh&nbsp;localhot</span></span></span></div></pre><p>如果能登录即配置成功<br>如果还是无法登录，注意修改文件目录和文件权限。</p>
    <h4 id="ssh-">SSH 配置</h4>
    <p>SSH 配置在 /etc/ssh/sshd_config  </p>
    <pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>sudo&nbsp;vim&nbsp;/etc/ssh/sshd_config</span></span></span></div></pre><p>进入配置文件，开始修改  </p>
    <p>修改 SSH 登录端口</p>
    <pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>#端口，修改成另外的端口。</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>Port&nbsp;22</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>#关闭密码登录，如果没有，就添加配置</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>PasswordAuthentication&nbsp;no</span></span></span></div></pre><h2 id="-fail2ban">配置 fail2ban</h2>
    <p>fail2ban 可以限制登录次数，保证不被穷举破解。<br>安装 fail2ban 执行命令</p>
    <pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>sudo&nbsp;apt-get&nbsp;install&nbsp;fail2ban</span></span></span></div></pre><p>配置 fail2ban 复制 jail.conf 到 jail.local 修改都在 jail.local 文件里</p>
    <pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>cd&nbsp;/etc/fail2ban</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>sudo&nbsp;cp&nbsp;jail.conf&nbsp;jail.local</span></span></span></div></pre><p>编辑配置文件</p>
    <pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>sudo&nbsp;vim&nbsp;jail.local</span></span></span></div></pre><p>修改配置文件，配置忽略 IP ，屏蔽时间，最大尝试次数。如下：</p>
    <pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>[DEFAULT]</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>#&nbsp;&quot;ignoreip&quot;&nbsp;can&nbsp;be&nbsp;an&nbsp;IP&nbsp;address,&nbsp;a&nbsp;CIDR&nbsp;mask&nbsp;or&nbsp;a&nbsp;DNS&nbsp;host</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>ignoreip&nbsp;=&nbsp;127.0.0.1</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>bantime&nbsp;&nbsp;=&nbsp;3600</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>maxretry&nbsp;=&nbsp;3</span></span></span></div></pre><p>可以根据自己的需要修改参数  </p>
    <p>设置邮件提醒，配置文件修改成自己的邮件地址  </p>
    <pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>destemail&nbsp;=&nbsp;your_email@domain.com</span></span></span></div></pre><p>找到并修改：</p>
    <pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>action&nbsp;=&nbsp;%(action_)s&nbsp;&nbsp;&nbsp;#&nbsp;找到这行</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>action&nbsp;=&nbsp;%(action_mw)s&nbsp;#&nbsp;修改成这样</span></span></span></div></pre><p>日志</p>
    <pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>[ssh]</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>enabled&nbsp;=&nbsp;true</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>port&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ssh</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>filter&nbsp;&nbsp;=&nbsp;sshd</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>logpath&nbsp;&nbsp;=&nbsp;/var/log/auth.log</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>maxretry&nbsp;=&nbsp;3</span></span></span></div></pre><p>配置完成后，退出 vim 并且重启 fail2ban</p>
    <pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>sudo&nbsp;/etc/init.d/fail2ban&nbsp;restart</span></span></span></div></pre><h2 id="-">修改时区</h2>
    <p>因为服务器或 VPS 机房可能在国外。不在同一个时区可能会有时差问题，修改服务器时间修改成本地时间，避免操作服务器的时候出现穿越的错觉。  </p>
    <pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>sudo&nbsp;tzconfig&nbsp;&nbsp;//如果命令不存在请使用</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>dpkg-reconfigure&nbsp;tzdata</span></span></span></div></pre><p>选择 Shanghai（上海）<br>然后复制配置，防止系统重启后时区改变  </p>
    <pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>sudo&nbsp;cp&nbsp;/usr/share/zoneinfo/Asia/ShangHai&nbsp;/etc/localtime</span></span></span></div></pre><p>设置网络时间同步</p>
    <pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>ntpdate&nbsp;cn.pool.ntp.org</span></span></span></div></pre><p>查看下当前时间是不是和本时区一致  </p>
    <pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>date</span></span></span></div></pre>

</div>
<footer>
    <a href="/about.html" target="_blank" class="muted">关于我</a>
</footer>
<script src="/status/min.js"></script>
<script type="text/javascript" src="http://tajs.qq.com/stats?sId=48893249" charset="UTF-8"></script>
</body>
